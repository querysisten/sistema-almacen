<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Consulta  de Piezas</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/marcas.css' ) }}">

  <!-- Librer√≠as para exportar Excel y PDF -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

  <style>
    .container-fluid {
      background-color: #a09999;
      padding: 20px;
      border-radius: 8px;
    }

    mark {
      background-color: #ffeb3b;
      color: black;
      padding: 0 2px;
      border-radius: 2px;
    }

    .input-group-text {
      background-color: #007bff;
      color: white;
    }

    .btn-success, .btn-danger {
      font-size: 14px;
    }

    .table {
      background-color: white;
    }
  </style>
</head>
<body>
<div class="container-fluid p-3">

  <!-- Encabezado centralizado -->
  <div class="text-center mb-4">
    <h1 class="display-5 fw-bold">Consulta Inventario de Piezas</h1>
  </div>

  <!-- Buscador -->
  <div class="input-group justify-content-center my-4" style="max-width: 600px; margin: auto;">
    <span class="input-group-text d-flex align-items-center justify-content-center" style="height: 50px;">
      <i class="bi bi-search"></i>
    </span>
    <input type="text" id="buscador" class="form-control" placeholder="Buscar pieza, marca o modelo..." style="height: 50px;" autofocus>
  </div>

  <!-- Botones Exportar -->
  <div class="d-flex justify-content-center mb-4" style="gap: 10px;">
    <button class="btn btn-success" id="exportExcel">
      <i class="bi bi-file-earmark-spreadsheet"></i> Exportar Excel
    </button>
    <button class="btn btn-danger" id="exportPDF">
      <i class="bi bi-file-earmark-pdf"></i> Exportar PDF
    </button>
  </div>

  <!-- Tabla de inventario -->
  <div class="table-responsive">
    <table class="table table-striped table-hover table-sm" id="tb_inventario">
      <thead class="table-dark text-start align-middle">
        <tr>
          <th class="text-start">#ID</th>
          <th class="text-start">Marca</th>
          <th class="text-start">Modelo</th>
          <th class="text-start">A√±o</th>
          <th class="text-start">Descripci√≥n</th>
          <th class="text-start">Cantidad</th>
          <th class="text-start">Almac√©n</th>
          <th class="text-start">Tramo</th>
          <th class="text-start">Anaquel</th>
          <th class="text-start">Estado</th>
          <th class="text-start">Fecha</th>
        </tr>
      </thead>
      <tbody>
        {% for d in dato %}
        <tr>
          <td class="text-start">{{ loop.index }}</td>
          <td class="text-start">{{ d.marca }}</td>
          <td class="text-start">{{ d.modelo }}</td>
          <td class="text-start">{{ d.anio }}</td>
          <td class="text-start">{{ d.descripcion }}</td>
          <td class="text-start">{{ d.cantidad }}</td>
          <td class="text-start">{{ d.almacen }}</td>
          <td class="text-start">{{ d.tramo }}</td>
          <td class="text-start">{{ d.anaquel }}</td>
          <td class="text-start">{{ d.estado }}</td>
          <td class="text-start">{{ d.fecha }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
// üîç Buscador en tiempo real con resaltado
const buscador = document.getElementById('buscador');
const tbody = document.querySelector('#tb_inventario tbody');

buscador.addEventListener('input', () => {
  const query = buscador.value.toLowerCase().trim();

  tbody.querySelectorAll('tr').forEach(tr => {
    let coincide = false;

    // Limpiar resaltado previo
    tr.querySelectorAll('td').forEach(td => td.innerHTML = td.textContent);

    // Buscar coincidencias
    tr.querySelectorAll('td').forEach(td => {
      const texto = td.textContent.toLowerCase();
      if (query && texto.includes(query)) {
        coincide = true;
        const regex = new RegExp(`(${query})`, 'gi');
        td.innerHTML = td.textContent.replace(regex, '<mark>$1</mark>');
      }
    });

    // Mostrar u ocultar
    tr.style.display = (query === '' || coincide) ? '' : 'none';
  });
});

// üìä Exportar Excel y abrir autom√°ticamente
document.getElementById('exportExcel').addEventListener('click', () => {
  const table = document.getElementById('tb_inventario');
  const wb = XLSX.utils.table_to_book(table, { sheet: "Inventario Piezas" });
  const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'array' });
  const blob = new Blob([wbout], { type: 'application/octet-stream' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'Inventario_Piezas.xlsx';
  a.click();
  URL.revokeObjectURL(url);
});

// üßæ Exportar PDF y abrir en nueva ventana
document.getElementById('exportPDF').addEventListener('click', () => {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Inventario de Piezas", 14, 20);
  doc.autoTable({
    startY: 25,
    html: '#tb_inventario',
    styles: { fontSize: 8 },
    headStyles: { fillColor: [0, 53, 128] }
  });
  const pdfUrl = doc.output('bloburl');
  window.open(pdfUrl, '_blank');
});
</script>
</body>
</html>